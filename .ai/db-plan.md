# HealthyMeal – Database Schema (PostgreSQL / Supabase)

## 1. Tables, Columns & Constraints

### `auth.users` (managed by Supabase Auth)

This table is provisioned automatically by Supabase and SHOULD NOT be modified directly in migrations. It holds core authentication data and acts as the parent table for `profiles`.

| Column             | Type        | Notes                                                                |
| ------------------ | ----------- | -------------------------------------------------------------------- |
| id                 | uuid        | Primary key referenced by `profiles.user_id`. Generated by Supabase. |
| email              | text        | Unique e-mail address (nullable when using social OAuth).            |
| encrypted_password | text        | Encrypted password for email-password sign-ups.                      |
| role               | text        | Supabase internal role field.                                        |
| created_at         | timestamptz | Timestamp of account creation.                                       |
| ...                | ...         | Additional auth-related columns managed by Supabase.                 |

> When writing migrations, reference this table as `auth.users`.

### 1.1 Enum Types

```sql
-- user account lifecycle
CREATE TYPE user_status_type AS ENUM ('active', 'pending_deletion', 'deleted');

-- binary recipe rating
CREATE TYPE rating_type AS ENUM ('up', 'down');
```

### 1.2 `profiles`

| Column            | Type             | Constraints                                              |
| ----------------- | ---------------- | -------------------------------------------------------- |
| user_id           | uuid             | PRIMARY KEY, REFERENCES auth.users(id) ON DELETE CASCADE |
| preferences       | text[]           | NOT NULL DEFAULT '{}'                                    |
| status            | user_status_type | NOT NULL DEFAULT 'active'                                |
| status_changed_at | timestamptz      | NOT NULL DEFAULT now()                                   |
| created_at        | timestamptz      | NOT NULL DEFAULT now()                                   |
| updated_at        | timestamptz      | NOT NULL DEFAULT now()                                   |

### 1.3 `recipes`

| Column                     | Type        | Constraints                                             |
| -------------------------- | ----------- | ------------------------------------------------------- |
| id                         | uuid        | PRIMARY KEY DEFAULT gen_random_uuid()                   |
| user_id                    | uuid        | NOT NULL REFERENCES profiles(user_id) ON DELETE CASCADE |
| title                      | text        | NOT NULL                                                |
| ingredients                | text        | NOT NULL (stored as string, not JSONB)                 |
| shopping_list              | text        | NOT NULL (stored as string, not JSONB)                 |
| instructions               | text        | NOT NULL (stored as string, not JSONB)                 |
| initial_user_query         | text        | NOT NULL                                                |
| is_visible                 | boolean     | NOT NULL DEFAULT true                                   |
| regenerated_from_recipe_id | uuid        | REFERENCES recipes(id)                                  |
| created_at                 | timestamptz | NOT NULL DEFAULT now()                                  |
| updated_at                 | timestamptz | NOT NULL DEFAULT now()                                  |

### 1.4 `ratings`

| Column      | Type                 | Constraints                                    |
| ----------- | -------------------- | ---------------------------------------------- |
| recipe_id   | uuid                 | REFERENCES recipes(id) ON DELETE CASCADE       |
| user_id     | uuid                 | REFERENCES profiles(user_id) ON DELETE CASCADE |
| rating      | rating_type          | NOT NULL                                       |
| created_at  | timestamptz          | NOT NULL DEFAULT now()                         |
| updated_at  | timestamptz          | NOT NULL DEFAULT now()                         |
| PRIMARY KEY | (recipe_id, user_id) | —                                              |

### 1.5 `ai_generations_log`

| Column        | Type          | Constraints                                             |
| ------------- | ------------- | ------------------------------------------------------- |
| id            | uuid          | PRIMARY KEY DEFAULT gen_random_uuid()                   |
| user_id       | uuid          | NOT NULL REFERENCES profiles(user_id) ON DELETE CASCADE |
| recipe_id     | uuid          | REFERENCES recipes(id) (nullable, updated after creation) |
| prompt        | text          | NOT NULL                                                |
| model         | text          |                                                         |
| input_tokens  | integer       | NOT NULL                                                |
| output_tokens | integer       |                                                         |
| cost          | numeric(10,6) |                                                         |
| created_at    | timestamptz   | NOT NULL DEFAULT now()                                  |

### 1.6 `saved_recipes`

| Column      | Type        | Constraints                                    |
| ----------- | ----------- | ---------------------------------------------- |
| id          | uuid        | PRIMARY KEY DEFAULT gen_random_uuid()          |
| user_id     | uuid        | NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE |
| recipe_id   | uuid        | NOT NULL REFERENCES recipes(id) ON DELETE CASCADE |
| created_at  | timestamptz | NOT NULL DEFAULT now()                         |
| UNIQUE      | (user_id, recipe_id) | —                                              |

---

## 2. Relationships

1. `auth.users` 1 — 1 `profiles`
2. `profiles` 1 — N `recipes` (`profiles.user_id` → `recipes.user_id`)
3. `recipes` 1 — 1 `recipes` (self-reference via `regenerated_from_recipe_id`)
4. `profiles` N — N `recipes` through `ratings`
5. `profiles` 1 — N `ai_generations_log`
6. `auth.users` N — N `recipes` through `saved_recipes`

---

## 3. Indices

```sql
-- profiles
CREATE INDEX idx_profiles_status ON profiles(status);

-- recipes
CREATE INDEX idx_recipes_user_created_at ON recipes(user_id, created_at DESC);
CREATE INDEX idx_recipes_visible ON recipes(is_visible) WHERE is_visible = true;
CREATE INDEX idx_recipes_regenerated ON recipes(regenerated_from_recipe_id);

-- ratings
CREATE INDEX idx_ratings_user ON ratings(user_id);
CREATE INDEX idx_ratings_recipe ON ratings(recipe_id);

-- ai_generations_log
CREATE INDEX idx_ai_logs_user_created_at ON ai_generations_log(user_id, created_at DESC);
CREATE INDEX idx_ai_logs_recipe ON ai_generations_log(recipe_id);

-- saved_recipes
CREATE INDEX idx_saved_recipes_user ON saved_recipes(user_id);
CREATE INDEX idx_saved_recipes_recipe ON saved_recipes(recipe_id);
CREATE INDEX idx_saved_recipes_created_at ON saved_recipes(created_at);
```

---

## 4. Row-Level Security (RLS) Policies (Supabase-style)

```sql
-- PROFILES ---------------------------------------------------------
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- users may view & modify only their own profile
CREATE POLICY "Profiles: owners can read" ON profiles
  FOR SELECT USING (auth.uid() = user_id AND status = 'active');
CREATE POLICY "Profiles: owners can update" ON profiles
  FOR UPDATE USING (auth.uid() = user_id);

-- RECIPES ----------------------------------------------------------
ALTER TABLE recipes ENABLE ROW LEVEL SECURITY;

-- owners see only visible recipes
CREATE POLICY "Recipes: owner read visible" ON recipes
  FOR SELECT USING (auth.uid() = user_id AND is_visible = true);

-- owners can insert their own rows
CREATE POLICY "Recipes: owner insert" ON recipes
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- owners can update only their rows
CREATE POLICY "Recipes: owner update" ON recipes
  FOR UPDATE USING (auth.uid() = user_id);

-- RATINGS ----------------------------------------------------------
ALTER TABLE ratings ENABLE ROW LEVEL SECURITY;

-- owners read/modify their ratings
CREATE POLICY "Ratings: owner select" ON ratings
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Ratings: owner insert" ON ratings
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Ratings: owner update" ON ratings
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Ratings: owner delete" ON ratings
  FOR DELETE USING (auth.uid() = user_id);

-- AI_GENERATIONS_LOG ----------------------------------------------
ALTER TABLE ai_generations_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "AI Logs: owner select" ON ai_generations_log
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "AI Logs: owner insert" ON ai_generations_log
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- SAVED_RECIPES ---------------------------------------------------
ALTER TABLE saved_recipes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Saved Recipes: owner select" ON saved_recipes
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Saved Recipes: owner insert" ON saved_recipes
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Saved Recipes: owner delete" ON saved_recipes
  FOR DELETE USING (auth.uid() = user_id);
```

---

## 5. Design Notes

- **Soft-delete of accounts**: `profiles.status` tracks lifecycle. A scheduled process (e.g. Supabase `pg_cron`) should periodically purge rows with `status = 'pending_deletion'` older than 30 days.
- **Enum usage** reinforces data integrity for user status and ratings.
- **Partial index on `recipes.is_visible`** speeds up listing visible recipes while ignoring hidden ones.
- **Self-reference in `recipes`** preserves regeneration history and allows easy traversal of variants.
- **Token & cost logging** in `ai_generations_log` provides accurate cost tracking for AI usage.
- **String storage for recipe content**: Ingredients, shopping list, and instructions are stored as strings rather than JSONB for simplicity and compatibility.
- **Saved recipes tracking**: Users can save/unsave recipes to their favorites with duplicate prevention.
- **AI generation workflow**: The `ai_generations_log` table tracks AI usage before recipe creation, then updates with the `recipe_id` after successful creation.

> The schema is normalized to 3NF, avoids data duplication, and is ready for translation into SQL migration files or Supabase migrations.
